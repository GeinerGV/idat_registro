var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var Datos=function(_React$Component){_inherits(Datos,_React$Component);function Datos(props){_classCallCheck(this,Datos);var _this=_possibleConstructorReturn(this,(Datos.__proto__||Object.getPrototypeOf(Datos)).call(this,props));_this.opciones=Object.keys(props.opciones);_this.state={selectedRow:0,tblHei:0,rowTipo:null,option:_this.opciones[0],cargando:false,page:0};_this.row_opcion=React.createRef();_this.getRows=_this.getRows.bind(_this);_this.getCurrRowsSource=_this.getCurrRowsSource.bind(_this);_this.handleChange=_this.handleChange.bind(_this);_this.setTableHeight=_this.setTableHeight.bind(_this);_this.getEditorPosY=_this.getEditorPosY.bind(_this);_this.handleMouseover=_this.handleMouseover.bind(_this);_this.exportarExcel=_this.exportarExcel.bind(_this);_this.handleOptionDataChange=_this.handleOptionDataChange.bind(_this);_this.dataLocalManager=_this.dataLocalManager.bind(_this);return _this}_createClass(Datos,[{key:"componentDidMount",value:function componentDidMount(){this.setTableHeight()}},{key:"componentDidUpdate",value:function componentDidUpdate(prevProps,prevState){this.setTableHeight()}},{key:"getEditorPosY",value:function getEditorPosY(){if(this.state.selectedRow&&this.state.selectedRow<this.getRows().length&&!this.state.cargando){return $("tbody tr:nth-child("+(this.state.selectedRow+1)+")").offset().top-$(".tbl-data").offset().top}return $(".tbl-data thead").height()}},{key:"parseDate",value:function parseDate(date){date=date.split(" ");var fecha=date[0].split("/");return new Date(fecha[1]+"/"+fecha[0]+"/"+fecha[2]+" "+date[1])}},{key:"getRowsSesKey",value:function getRowsSesKey(option){if(!option)option=this.state.option;return"data-datos-"+option}},{key:"getRows",value:function getRows(){var ses_data=sessionStorage.getItem(this.getRowsSesKey());var parseDate=this.parseDate;if(ses_data){ses_data=JSON.parse(ses_data);var num_rows=this.row_opcion.current?this.row_opcion.current.value:20;var keys_data=[];switch(this.state.option){case"ingreso":keys_data=Object.values(ses_data).sort(function(a,b){return parseDate(a[5])-parseDate(b[5])}).reverse().splice(0,num_rows);break;default:keys_data=Object.values(ses_data).sort(function(a,b){return parseDate(a[1])-parseDate(b[1])}).reverse().splice(0,num_rows);break;}return keys_data}return[]}},{key:"getCurrRowsSource",value:function getCurrRowsSource(){return this.getRowsSource(this.state.option)}},{key:"getRowsSource",value:function getRowsSource(option){if(this.opciones.includes(option)){var ses_data=sessionStorage.getItem(this.getRowsSesKey(option));if(ses_data){ses_data=JSON.parse(ses_data);return ses_data}}return null}},{key:"setCurrRowsSource",value:function setCurrRowsSource(rows){this.setRowsSource(this.state.option,rows)}},{key:"setRowsSource",value:function setRowsSource(option,rows){if(this.opciones.includes(option)&&(typeof rows==="undefined"?"undefined":_typeof(rows))=="object"){var ses_data=sessionStorage.getItem(this.getRowsSesKey(option));if(ses_data){ses_data=JSON.parse(ses_data);if(!Array.isArray(rows)){ses_data=rows}else{ses_data={};rows.forEach(function(val){Object.assign(ses_data,_defineProperty({},val[0],val))})}}sessionStorage.setItem(this.getRowsSesKey(option),JSON.stringify(ses_data))}}},{key:"setTableHeight",value:function setTableHeight(){var hei=$(".tbl-data").height()+17+20;if(hei!=this.state.tblHei)this.setState({tblHei:hei})}},{key:"dataLocalManager",value:function dataLocalManager(data){dataManager(data)}},{key:"exportarExcel",value:function exportarExcel(e){var xmlhttp=new XMLHttpRequest;var params="export_data=true&rows="+this.row_opcion.current.value;xmlhttp.onreadystatechange=function(){if(this.readyState==4&&this.status==200){$("#datos-cnt").prepend(Alerta({tipo:"success",msg:"Exportado exitosamente"}))}};xmlhttp.open("POST","/datos",true);xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");xmlhttp.send(params)}},{key:"getDownloadDataParams",value:function getDownloadDataParams(config){if(!config)config={};if(!config.option)config.option=this.state.option;var params=new URLSearchParams;params.append("json",true);if(this.row_opcion.current.value!=20)params.append("rows",this.row_opcion.current.value);if(config.option!=this.opciones[0])params.append("view",config.option);if(this.state.page>0)params.append("page",this.state.page);return params.toString()}},{key:"handleChange",value:function handleChange(e){this.setState({cargando:true,selectedRow:0});var xmlhttp=new XMLHttpRequest;var this_tmp=this;xmlhttp.onreadystatechange=function(){if(this.readyState==4&&this.status==200){this_tmp.dataLocalManager(JSON.parse(this.responseText));this_tmp.setState({cargando:false})}};var view=this.state.option!=this.opciones[0]?"&view="+this.state.option:"";xmlhttp.open("GET","/datos?"+this.getDownloadDataParams(),true);xmlhttp.send()}},{key:"handleMouseover",value:function handleMouseover(e){this.setState({selectedRow:e.currentTarget.sectionRowIndex,rowTipo:"active"})}},{key:"setRowTipo",value:function setRowTipo(tipo){this.setState({rowTipo:tipo});return null}},{key:"handleOptionDataChange",value:function handleOptionDataChange(e){var option=e.target.querySelector("input").id;this.setState({option:option,cargando:true,selectedRow:0});var xmlhttp=new XMLHttpRequest;var this_tmp=this;xmlhttp.onreadystatechange=function(){if(this.readyState==4&&this.status==200){this_tmp.dataLocalManager(JSON.parse(this.responseText));this_tmp.setState({cargando:false})}};xmlhttp.open("GET","/datos?"+this.getDownloadDataParams({option:option}),true);xmlhttp.send()}},{key:"getDataSelectedRow",value:function getDataSelectedRow(){return this.getRows()[this.state.selectedRow]}},{key:"getPages",value:function getPages(){var limits=sessionStorage.getItem("data-datos-limits");if(limits){limits=JSON.parse(limits)}}},{key:"render",value:function render(){var _this2=this;var thead=this.props.opciones[this.state.option].thead.map(function(val){return React.createElement("th",{key:val},val)});var rows=!this.state.cargando?this.getRows().map(function(row,id){return React.createElement(Row,{key:"row"+id,tipo:id==_this2.state.selectedRow?_this2.state.rowTipo:null,onMouseOver:_this2.handleMouseover,cols:row,pos:id,idAtencion:row[0]})}):React.createElement("tr",null,React.createElement("td",{className:"text-center",colSpan:thead.length},"Cargando ..."));var tblHei=this.state.tblHei;var options=this.opciones.map(function(opt){return React.createElement(OpcionesDatos,{onHandler:_this2.handleOptionDataChange,active:opt==_this2.state.option,id:opt,txt:_this2.props.opciones[opt].txt,key:opt})});return React.createElement(React.Fragment,null,React.createElement("form",{className:"form-inline",style:{display:"flex",alignItems:"center",justifyContent:"space-between"},onSubmit:this.exportarExcel,method:"POST"},React.createElement("input",{type:"hidden",name:"export_data",value:"true"}),React.createElement("button",{type:"submit",className:"btn btn-default btn-lg"},"EXPORTAR ",React.createElement("i",{className:"glyphicon glyphicon-file"})),React.createElement("div",{className:"form-group"},React.createElement("div",{className:"btn-group","data-toggle":"buttons"},options)),React.createElement("div",{className:"form-group pull-right"},React.createElement("select",{className:"form-control",ref:this.row_opcion,onChange:this.handleChange,defaultValue:"20"},React.createElement("option",{value:"10"},"10"),React.createElement("option",{value:"20"},"20"),React.createElement("option",{value:"30"},"30")))),React.createElement("div",{className:"tbl-cnt",style:{display:"flex",maxWidth:"100wp",width:"100%"}},this.props.canEdit&&typeof AdminRows!="undefined"&&this.getRows().length>0&&React.createElement("div",{className:"edit-tbl-row-cnt"},React.createElement(AdminRows,{posY:this.getEditorPosY(),dataRow:rows[this.state.selectedRow]})),React.createElement("div",{style:{height:tblHei+"px",width:"100%",overflowX:"overlay",overflowY:"hidden",position:"relative"}},React.createElement("table",{className:"table table-hover tbl-data",style:{position:"absolute"}},React.createElement("thead",null,React.createElement("tr",null,thead)),React.createElement("tbody",null,rows)))))}}]);return Datos}(React.Component);function goTo(props){React.createElement("li",null,React.createElement("a",{href:"#","aria-label":""},React.createElement("span",{"aria-hidden":"true"},"\xAB")))}function Row(props){var columns=props.cols.map(function(col,id){return id==0?React.createElement("td",{key:"col"+id},props.pos+1):React.createElement("td",{key:"col"+id},col)});var optionalAttrs=props.tipo?{className:props.tipo}:{};return React.createElement("tr",Object.assign({onMouseOver:props.onMouseOver},optionalAttrs),columns)}function OpcionesDatos(props){return React.createElement("label",{className:"btn btn-"+(props.active?"warning active":"default"),onClick:props.onHandler},React.createElement("input",{type:"radio",name:"options",id:props.id})," ",props.txt)}var DATOS_REF=React.createRef();function getInitPropsDatos(){var result={rows:[]};var ses_view=sessionStorage.getItem("view-datos");if(ses_view){Object.assign(result,JSON.parse(ses_view))}return result}$(ReactDOM.render(React.createElement(Datos,Object.assign({ref:DATOS_REF},getInitPropsDatos())),document.querySelector("#datos-cnt")));
//# sourceMappingURL=datos.js.map